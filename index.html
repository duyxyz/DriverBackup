# ==============================
# DRIVER BACKUP TOOL (PowerShell)
# Auto elevate to Administrator
# ==============================

# Nếu chưa chạy với quyền Admin → mở lại chính nó với RunAs
if (-not ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()
).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Start-Process powershell.exe "-NoProfile -ExecutionPolicy Bypass -File `"$PSCommandPath`"" -Verb RunAs
    exit
}

Add-Type -AssemblyName System.Windows.Forms

function Pause-Key {
    Write-Host ""
    Write-Host "Press Enter to continue..."
    [void][System.Console]::ReadLine()
}

function DB-Menu {
    Clear-Host
    Write-Host "DRIVER BACKUP TOOL"
    Write-Host "------------------"
    Write-Host "1. Backup drivers"
    Write-Host "2. Restore drivers"
    Write-Host "3. Check missing/faulty drivers"
    Write-Host "4. Exit"
    Write-Host "------------------"
}

function DB-PickFolder {
    $fbd = New-Object System.Windows.Forms.FolderBrowserDialog
    $fbd.Description = "Select folder"
    $fbd.ShowNewFolderButton = $true
    if ($fbd.ShowDialog() -eq [System.Windows.Forms.DialogResult]::OK) {
        return $fbd.SelectedPath
    } else {
        $default = "C:\DriverBackup"
        if (!(Test-Path $default)) { New-Item -ItemType Directory -Path $default | Out-Null }
        return $default
    }
}

function DB-Backup {
    $folder = DB-PickFolder
    Write-Host "Backing up drivers to $folder ..."
    dism /online /export-driver /destination:$folder
    Write-Host "Backup completed."
    Pause-Key
}

function DB-Restore {
    $folder = DB-PickFolder
    if (!(Test-Path $folder)) {
        Write-Host "Folder not found!"
        Pause-Key
        return
    }
    Write-Host "Restoring drivers from $folder ..."
    pnputil /add-driver "$folder\*.inf" /subdirs /install
    Write-Host "Restore completed."
    Pause-Key
}

function DB-Check {
    Write-Host "Checking for missing/faulty drivers..."
    $drivers = Get-CimInstance Win32_PnPEntity | Where-Object { $_.ConfigManagerErrorCode -ne 0 }
    if ($drivers) {
        Write-Host ""
        Write-Host "List of missing/faulty drivers:"
        $drivers | ForEach-Object { Write-Host "$($_.Name) - ErrorCode: $($_.ConfigManagerErrorCode)" }
    } else {
        Write-Host "No missing/faulty drivers detected."
    }
    Pause-Key
}

do {
    DB-Menu
    $choice = Read-Host "Choose option [1-4]"
    switch ($choice) {
        "1" { DB-Backup }
        "2" { DB-Restore }
        "3" { DB-Check }
        "4" { break }
        default { Write-Host "Invalid option."; Pause-Key }
    }
} while ($choice -ne "4")

Write-Host "Exiting..."
